name: Release a new version

defaults:
  run:
    shell: pwsh

on:
  pull_request:
    branches:
      - master
    types:
      - closed

jobs:
  merged_build:
    name: Merged build
    if: github.event.pull_request.merged
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{matrix.os}}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Get bump tag
        run: |
          Set-Content -Path Env:COMMIT_MESSAGE -Value (git show --pretty=%B)
          if ((Get-Content -Path Env:COMMIT_MESSAGE) -match '!major') {
            Set-Content -Path Env:BUMP_TAG -Value 'major'
          } elseif ((Get-Content -Path Env:COMMIT_MESSAGE) -match '!minor') {
            Set-Content -Path Env:BUMP_TAG -Value 'minor'
          } elseif ((Get-Content -Path Env:COMMIT_MESSAGE) -match '!patch') {
            Set-Content -Path Env:BUMP_TAG -Value 'patch'
          } else {Exit(1)}
      
      - name: Bump version
        run: |
          cargo install cargo-edit
          cargo set-version --bump (Get-Content -Path Env:BUMP_TAG)
          Set-Content -Path Env:VERSION_STRING -Value ('v' + (Get-Content -Raw .\cargo.toml | Select-String -Pattern '(?s)\[package\].*?version = "(\d\.\d\.\d)"').Matches.Groups[1].Value)
      
      - name: Update
        run: cargo update
      
      - name: Build
        run: cargo build --release --verbose
      
      - name: Package
        run: |
          New-Item -ItemType Directory -Path ./artifacts/
          Compress-Archive -Path './target/release/*' -DestinationPath './artifacts/soundsense-rs-' + (Get-Content -Path Env:VERSION_STRING) + '-${{runner.os}}.zip'
      
      - name: Commit
        run: |
          git add cargo.toml
          git commit -m ("Automated version bump to " + (Get-Content -Path Env:VERSION_STRING))
      
      - name: Tag
        run: git tag (Get-Content -Path Env:VERSION_STRING)
      
      - name: Push back
        run: git push --tags
      
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./artifacts/*
